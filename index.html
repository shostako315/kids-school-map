<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kids School Finder Pro</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg:#0f172a;
      --panel:#1e293b;
      --border:#334155;
      --text:#f8fafc;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --favorite:#fbbf24;
      --danger:#f87171;
    }
    *{ box-sizing:border-box; }
    body { margin:0; font-family: sans-serif; background:var(--bg); color:var(--text); overflow: hidden; }
    
    header {
      height: 60px;
      padding: 0 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
    }

    #app {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* Sidebar Area */
    #left {
      width: 400px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--panel);
    }
    .scroll-area { overflow-y: auto; flex: 1; padding: 16px; }

    /* Controls */
    .filter-group { margin-bottom: 16px; }
    label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: block; }
    select, input {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg); color: var(--text); font-size: 14px;
    }

    .btn-main {
      width: 100%; padding: 12px; border-radius: 8px; border: 0; font-weight: bold;
      background: var(--accent); color: #0f172a; cursor: pointer; transition: opacity 0.2s;
    }
    .btn-main:disabled { opacity: 0.5; }

    /* List Items */
    .list-item {
      background: var(--bg); border: 1px solid var(--border); border-radius: 12px;
      padding: 12px; margin-bottom: 10px; cursor: pointer; position: relative;
    }
    .list-item:hover { border-color: var(--accent); }
    .list-item.active { border-color: var(--accent); ring: 2px solid var(--accent); }
    .item-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; padding-right: 25px; }
    .item-meta { font-size: 12px; color: var(--muted); display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { background: #334155; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    
    .fav-btn {
      position: absolute; top: 12px; right: 12px; border: 0; background: transparent;
      color: var(--muted); cursor: pointer; font-size: 18px;
    }
    .fav-btn.is-fav { color: var(--favorite); }

    /* Map Area */
    #right { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .map-overlay-btn {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: var(--panel); color: white; border: 1px solid var(--border);
      padding: 8px 16px; border-radius: 20px; cursor: pointer; display: none;
    }

    /* Mobile */
    @media (max-width: 768px) {
      #app { flex-direction: column; overflow: auto; }
      #left { width: 100%; height: auto; border-right: 0; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>

<header>
  <strong><i class="fas fa-graduation-cap"></i> Kids School Finder</strong>
  <div id="stat-info" style="font-size: 12px; color: var(--muted);"></div>
</header>

<div id="app">
  <aside id="left">
    <div class="scroll-area">
      <div class="filter-group">
        <div style="display: flex; gap: 8px;">
          <div style="flex: 1;">
            <label>カテゴリ</label>
            <select id="category">
              <option value="school">一般学習塾・学校</option>
              <option value="kindergarten">幼稚園・保育園</option>
              <option value="language_school">英語・語学教室</option>
              <option value="music_school">音楽教室</option>
              <option value="arts_centre">絵画・カルチャー</option>
              <option value="sports_centre">体操・スポーツ</option>
              <option value="all">すべて表示</option>
            </select>
          </div>
          <div style="width: 100px;">
            <label>半径</label>
            <select id="radius">
              <option value="1000">1km</option>
              <option value="3000" selected>3km</option>
              <option value="5000">5km</option>
            </select>
          </div>
        </div>
      </div>

      <button id="search-btn" class="btn-main">現在地周辺を検索</button>

      <div style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin:0; font-size: 14px;">検索結果 <span id="count">0</span>件</h4>
          <select id="sort-order" style="width: auto; padding: 4px; font-size: 12px;">
            <option value="dist">距離が近い順</option>
            <option value="name">名前順</option>
          </select>
        </div>
        <ul id="list"></ul>
      </div>
    </div>
  </aside>

  <main id="right">
    <button id="move-search-btn" class="map-overlay-btn">このエリアで再検索</button>
    <div id="map"></div>
  </main>
</div>

<script>
  // --- 1. 設定 & 初期化 ---
  const CONFIG = {
    categories: {
      school: { color: '#38bdf8', icon: 'fa-book' },
      kindergarten: { color: '#f472b6', icon: 'fa-child' },
      language_school: { color: '#fbbf24', icon: 'fa-language' },
      music_school: { color: '#a78bfa', icon: 'fa-music' },
      arts_centre: { color: '#fb7185', icon: 'fa-palette' },
      sports_centre: { color: '#4ade80', icon: 'fa-running' }
    }
  };

  const map = L.map('map').setView([35.681, 139.767], 14);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let markers = L.layerGroup().addTo(map);
  let favorites = JSON.parse(localStorage.getItem('fav_schools') || '[]');
  let currentData = [];
  let userPos = null;

  // --- 2. APIクエリ作成 ---
  function buildQuery(lat, lon, radius, cat) {
    const types = cat === "all" ? Object.keys(CONFIG.categories) : [cat];
    const filters = types.map(t => `nwr["amenity"="${t}"](around:${radius},${lat},${lon});`).join("");
    return `[out:json][timeout:25];(${filters});out center;`;
  }

  // --- 3. 検索実行 ---
  async function performSearch(lat, lon, isMoving = false) {
    const radius = document.getElementById("radius").value;
    const cat = document.getElementById("category").value;
    const btn = document.getElementById("search-btn");
    
    btn.disabled = true;
    btn.textContent = "検索中...";
    document.getElementById("move-search-btn").style.display = "none";

    try {
      const q = buildQuery(lat, lon, radius, cat);
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(q)
      });
      const data = await res.json();
      
      currentData = data.elements.map(e => {
        const pos = [e.lat || e.center.lat, e.lon || e.center.lon];
        const dist = L.latLng(lat, lon).distanceTo(L.latLng(pos));
        return { ...e, pos, dist };
      });

      renderUI();
    } catch (e) {
      alert("データの取得に失敗しました。");
    } finally {
      btn.disabled = false;
      btn.textContent = "現在地周辺を検索";
    }
  }

  // --- 4. 描画ロジック ---
  function renderUI() {
    const listEl = document.getElementById("list");
    const sort = document.getElementById("sort-order").value;
    
    // ソート
    currentData.sort((a, b) => sort === "dist" ? a.dist - b.dist : (a.tags.name || "").localeCompare(b.tags.name || ""));

    listEl.innerHTML = "";
    markers.clearLayers();

    currentData.forEach(item => {
      const tags = item.tags || {};
      const name = tags.name || tags["name:ja"] || "名称不明の施設";
      const catInfo = CONFIG.categories[tags.amenity] || { color: '#ccc', icon: 'fa-location-dot' };
      const isFav = favorites.includes(item.id);

      // マーカー追加
      const markerIcon = L.divIcon({
        html: `<div style="background:${catInfo.color}; width:30px; height:30px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; color:white;">
                <i class="fas ${catInfo.icon}" style="font-size:12px;"></i>
               </div>`,
        className: '',
        iconSize: [30, 30]
      });

      const m = L.marker(item.pos, { icon: markerIcon }).addTo(markers);
      m.bindPopup(`<strong>${name}</strong><br>${tags["addr:full"] || ""}`);

      // リスト追加
      const li = document.createElement("li");
      li.className = "list-item";
      li.innerHTML = `
        <button class="fav-btn ${isFav ? 'is-fav' : ''}" onclick="toggleFav(${item.id}, event)">
          <i class="${isFav ? 'fas' : 'far'} fa-star"></i>
        </button>
        <div class="item-title">${name}</div>
        <div class="item-meta">
          <span class="tag" style="color:${catInfo.color}">${tags.amenity}</span>
          <span><i class="fas fa-walking"></i> ${(item.dist/1000).toFixed(1)}km</span>
        </div>
      `;
      li.onclick = () => {
        map.flyTo(item.pos, 16);
        m.openPopup();
      };
      listEl.appendChild(li);
    });

    document.getElementById("count").textContent = currentData.length;
  }

  // --- 5. インタラクション ---
  function toggleFav(id, event) {
    event.stopPropagation();
    if (favorites.includes(id)) {
      favorites = favorites.filter(f => f !== id);
    } else {
      favorites.push(id);
    }
    localStorage.setItem('fav_schools', JSON.stringify(favorites));
    renderUI();
  }

  // 現在地ボタン
  document.getElementById("search-btn").onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      userPos = [pos.coords.latitude, pos.coords.longitude];
      map.setView(userPos, 14);
      L.circleMarker(userPos, { radius: 8, color: '#fff', fillOpacity: 1, fillColor: '#38bdf8' }).addTo(map);
      performSearch(userPos[0], userPos[1]);
    });
  };

  // 地図移動検知
  map.on('moveend', () => {
    document.getElementById("move-search-btn").style.display = "block";
  });

  document.getElementById("move-search-btn").onclick = () => {
    const center = map.getCenter();
    performSearch(center.lat, center.lng, true);
  };

  document.getElementById("sort-order").onchange = renderUI;

</script>
</body>
</html>
