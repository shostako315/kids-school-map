<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kids School Finder Platinum</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #4338ca; --primary-light: #eef2ff;
      --accent: #f59e0b; --bg: #f1f5f9; --panel: #ffffff;
      --text: #0f172a; --muted: #64748b; --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    header {
      height: 64px; padding: 0 24px; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; z-index: 1100; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #container { display: flex; flex: 1; overflow: hidden; }

    /* サイドバー: 多機能パネル */
    #sidebar { width: 440px; display: flex; flex-direction: column; background: var(--panel); border-right: 1px solid var(--border); z-index: 1000; }
    
    .tabs { display: flex; border-bottom: 1px solid var(--border); background: #f8fafc; }
    .tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-size: 14px; font-weight: bold; color: var(--muted); border-bottom: 2px solid transparent; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; }

    .panel-content { flex: 1; overflow-y: auto; padding: 20px; }
    
    /* 検索フォーム */
    .search-box { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 12px; font-weight: bold; color: var(--muted); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; outline: none; }
    input:focus { border-color: var(--primary); ring: 2px solid var(--primary-light); }

    .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

    /* スクールカード */
    .school-card { border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fff; cursor: pointer; transition: 0.3s; position: relative; }
    .school-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .school-card.active { border-left: 5px solid var(--primary); background: var(--primary-light); }
    .school-name { font-weight: bold; font-size: 16px; color: var(--text); margin-bottom: 8px; padding-right: 30px; }
    .info-row { display: flex; gap: 12px; font-size: 12px; color: var(--muted); margin-top: 6px; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; background: #fff; border: 1px solid var(--border); }
    
    .fav-star { position: absolute; top: 16px; right: 16px; font-size: 20px; color: #cbd5e1; cursor: pointer; }
    .fav-star.active { color: var(--accent); }

    /* アクションボタン（詳細表示用） */
    .actions { display: flex; gap: 8px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .action-btn { flex: 1; padding: 8px; font-size: 12px; border-radius: 6px; text-align: center; text-decoration: none; background: #f8fafc; border: 1px solid var(--border); color: var(--text); }
    .action-btn:hover { background: #fff; border-color: var(--primary); color: var(--primary); }

    /* マップエリア */
    #map-wrapper { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .map-controls { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .auto-search-toggle { background: #fff; padding: 8px 16px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .auto-search-toggle input { width: auto; cursor: pointer; }

    @media (max-width: 900px) {
      #container { flex-direction: column; overflow: auto; }
      #sidebar { width: 100%; height: auto; border-right: none; }
      #map-wrapper { height: 350px; }
    }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:12px;">
    <i class="fas fa-graduation-cap" style="font-size:24px; color:var(--primary);"></i>
    <strong style="font-size:1.2rem;">Kids School Finder <span style="font-weight:normal; font-size:12px; color:var(--muted);">Platinum v2.0</span></strong>
  </div>
  <div id="status-badge" style="background:var(--primary-light); color:var(--primary); padding:4px 12px; border-radius:20px; font-size:12px; font-weight:bold;">
    <span id="hit-count">0</span>件のスクールが見つかりました
  </div>
</header>

<div id="container">
  <aside id="sidebar">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('search')"><i class="fas fa-search"></i> 探す</div>
      <div class="tab" onclick="switchTab('fav')"><i class="fas fa-star"></i> お気に入り (<span id="fav-count">0</span>)</div>
    </div>

    <div id="search-panel" class="panel-content">
      <div class="search-box">
        <div class="field">
          <label>場所（エリア・駅名）</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="area-input" placeholder="例: 自由が丘, 港区">
            <button class="btn-primary" style="width:50px;" onclick="searchArea()"><i class="fas fa-location-arrow"></i></button>
          </div>
        </div>
        <div class="field">
          <label>カテゴリ</label>
          <select id="cat-select" onchange="performSearch()">
            <option value="all">すべて表示</option>
            <option value="tutoring_centre">学習塾・進学塾</option>
            <option value="language_school">英語・英会話教室</option>
            <option value="music_school">音楽・ピアノ教室</option>
            <option value="sports_centre">体操・スポーツスクール</option>
            <option value="dance_school">ダンス・バレエ</option>
            <option value="coding_school">プログラミング教室</option>
          </select>
        </div>
        <button class="btn-primary" onclick="searchNearMe()"><i class="fas fa-street-view"></i> 現在地周辺を検索</button>
      </div>

      <div id="school-list">
        <div style="text-align:center; color:var(--muted); margin-top:40px;">
          <i class="fas fa-map-marked-alt fa-3x" style="opacity:0.3; margin-bottom:10px;"></i><br>
          地図を動かすか、エリアを入力して<br>スクールを探しましょう
        </div>
      </div>
    </div>

    <div id="fav-panel" class="panel-content" style="display:none;">
      <div id="fav-list"></div>
    </div>
  </aside>

  <main id="map-wrapper">
    <div class="map-controls">
      <label class="auto-search-toggle">
        <input type="checkbox" id="auto-search" checked> 地図を動かして自動検索
      </label>
    </div>
    <div id="map"></div>
  </main>
</div>

<script>
  // --- 初期設定 ---
  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 14);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  // 明るい地図タイル
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // クラスターレイヤー
  const clusters = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 50
  }).addTo(map);

  let allSchools = [];
  let favorites = JSON.parse(localStorage.getItem('ksf_favorites') || '[]');

  // --- 検索機能 ---
  async function performSearch() {
    const center = map.getCenter();
    const cat = document.getElementById('cat-select').value;
    const radius = 2500; // 2.5km

    const filter = cat === 'all' 
      ? `["amenity"~"school|kindergarten|tutoring_centre|language_school|music_school"]`
      : `["amenity"="${cat}"]`;
    
    const query = `[out:json][timeout:25];(nwr${filter}(around:${radius},${center.lat},${center.lng}););out center;`;
    
    try {
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query)
      });
      const data = await res.json();
      allSchools = data.elements.map(e => ({
        id: e.id,
        name: e.tags.name || e.tags["name:ja"] || "名称不明のスクール",
        lat: e.lat || e.center.lat,
        lon: e.lon || e.center.lon,
        tags: e.tags,
        dist: center.distanceTo(L.latLng(e.lat || e.center.lat, e.lon || e.center.lon))
      })).sort((a,b) => a.dist - b.dist);

      updateUI();
    } catch(e) { console.error("Search failed", e); }
  }

  function updateUI() {
    clusters.clearLayers();
    const listEl = document.getElementById('school-list');
    listEl.innerHTML = "";
    
    document.getElementById('hit-count').innerText = allSchools.length;
    document.getElementById('fav-count').innerText = favorites.length;

    allSchools.forEach(school => {
      const isFav = favorites.some(f => f.id === school.id);
      
      // マーカー
      const marker = L.marker([school.lat, school.lon]);
      marker.bindPopup(`<strong>${school.name}</strong>`);
      clusters.addLayer(marker);

      // カード
      const card = document.createElement('div');
      card.className = "school-card";
      card.innerHTML = `
        <i class="fa-star ${isFav ? 'fas active' : 'far'} fav-star" onclick="toggleFav(${school.id}, event)"></i>
        <div class="school-name">${school.name}</div>
        <div class="info-row">
          <span><i class="fas fa-map-marker-alt"></i> ${Math.round(school.dist)}m</span>
          <span class="tag">${school.tags.amenity || 'スクール'}</span>
        </div>
        <div class="actions">
          <a class="action-btn" href="https://www.google.com/maps/dir/?api=1&destination=${school.lat},${school.lon}" target="_blank">
            <i class="fas fa-route"></i> ルート
          </a>
          <a class="action-btn" href="https://www.google.com/search?q=${encodeURIComponent(school.name)}" target="_blank">
            <i class="fas fa-external-link-alt"></i> 詳細
          </a>
          ${school.tags.phone ? `<a class="action-btn" href="tel:${school.tags.phone}"><i class="fas fa-phone"></i> 電話</a>` : ''}
        </div>
      `;
      card.onclick = () => {
        map.flyTo([school.lat, school.lon], 16);
        marker.openPopup();
        document.querySelectorAll('.school-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
      };
      listEl.appendChild(card);
    });
  }

  // --- お気に入り機能 ---
  function toggleFav(id, event) {
    event.stopPropagation();
    const school = allSchools.find(s => s.id === id) || favorites.find(s => s.id === id);
    if(!school) return;

    const idx = favorites.findIndex(f => f.id === id);
    if(idx > -1) favorites.splice(idx, 1);
    else favorites.push(school);

    localStorage.setItem('ksf_favorites', JSON.stringify(favorites));
    updateUI();
    renderFavs();
  }

  function renderFavs() {
    const favList = document.getElementById('fav-list');
    favList.innerHTML = favorites.length ? "" : "<p style='color:var(--muted);'>お気に入りはまだありません。</p>";
    favorites.forEach(school => {
      const div = document.createElement('div');
      div.className = "school-card";
      div.innerHTML = `
        <i class="fas fa-star fav-star active" onclick="toggleFav(${school.id}, event)"></i>
        <div class="school-name">${school.name}</div>
        <div class="actions">
          <a class="action-btn" href="https://www.google.com/maps/dir/?api=1&destination=${school.lat},${school.lon}" target="_blank">ルート</a>
        </div>
      `;
      favList.appendChild(div);
    });
  }

  // --- インタラクション ---
  function switchTab(type) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
    
    if(type === 'search') {
      document.querySelector('.tab:nth-child(1)').classList.add('active');
      document.getElementById('search-panel').style.display = 'block';
    } else {
      document.querySelector('.tab:nth-child(2)').classList.add('active');
      document.getElementById('fav-panel').style.display = 'block';
      renderFavs();
    }
  }

  async function searchArea() {
    const val = document.getElementById('area-input').value;
    if(!val) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
    const data = await res.json();
    if(data[0]) {
      map.setView([data[0].lat, data[0].lon], 15);
      performSearch();
    }
  }

  function searchNearMe() {
    navigator.geolocation.getCurrentPosition(p => {
      map.setView([p.coords.latitude, p.coords.longitude], 15);
      performSearch();
    });
  }

  // 地図移動での自動検索（debounceで負荷軽減）
  let searchTimer;
  map.on('moveend', () => {
    if(document.getElementById('auto-search').checked) {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(performSearch, 800);
    }
  });

  // 初回ロード
  renderFavs();
</script>
</body>
</html>
