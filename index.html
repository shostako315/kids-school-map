<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>近くの子ども向けスクール検索（ガワ）</title>

  <!-- Leaflet (No token required) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101823;
      --panel2:#0f1621;
      --border:#1b2633;
      --border2:#233347;
      --text:#e8eef6;
      --muted:rgba(232,238,246,.78);
      --accent:#6ee7ff;
      --danger:#ffb4b4;
    }
    *{ box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:var(--bg); color:var(--text); }
    header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
    }
    header strong{ font-size:14px; letter-spacing:.2px; }
    #app{
      display:grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 52px);
      min-height: 520px;
    }
    #left{
      border-right:1px solid var(--border);
      overflow:auto;
      padding:12px;
    }
    #map{
      width:100%;
      height:100%;
      background:#0a0f14;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:10px 0 6px;
    }
    select, input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border2);
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    button{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:0;
      font-weight:700;
      cursor:pointer;
      background:var(--accent);
      color:#061018;
      margin-top:10px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    ul{ list-style:none; padding:0; margin:0; }
    li{
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:8px;
      cursor:pointer;
      background:var(--panel2);
    }
    li:hover{ border-color:#335a86; }
    .title{ font-weight:700; font-size:13px; }
    .meta{ font-size:12px; color:var(--muted); margin-top:4px; line-height:1.3; }
    .detail a{ color:var(--accent); text-decoration:none; }
    .detail a:hover{ text-decoration:underline; }
    .badge{
      display:inline-block;
      font-size:11px;
      padding:3px 8px;
      border:1px solid var(--border2);
      border-radius:999px;
      margin-right:6px;
      color:var(--muted);
    }
    .row{ display:flex; gap:8px; }
    .row > div{ flex:1; }
    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.5; }

    /* Mobile */
    @media (max-width: 900px){
      #app{ grid-template-columns: 1fr; grid-template-rows: 52vh 1fr; height:auto; }
      #left{ order:2; border-right:0; border-top:1px solid var(--border); }
      #map{ order:1; height:52vh; }
    }
  </style>
</head>

<body>
<header>
  <strong>近くの子ども向け塾/スクール検索（ガワ）</strong>
  <span style="color:var(--muted);font-size:12px;">Leaflet + OSM + Overpass</span>
</header>

<div id="app">
  <aside id="left">
    <div class="card">
      <div class="row">
        <div>
          <label>半径</label>
          <select id="radius">
            <option value="500">500m</option>
            <option value="1000" selected>1km</option>
            <option value="2000">2km</option>
            <option value="5000">5km</option>
          </select>
        </div>
        <div>
          <label>カテゴリ</label>
          <select id="category">
            <option value="kindergarten">幼稚園/保育（kindergarten）</option>
            <option value="school" selected>学校（school）</option>
            <option value="language_school">語学教室（language_school）</option>
            <option value="music_school">音楽教室（music_school）</option>
            <option value="all">全部（上記まとめて）</option>
          </select>
        </div>
      </div>

      <button id="btn">現在地周辺を検索</button>

      <div class="hint">
        ※ガワ版：紹介文の“自動転載”はしません（規約/品質の地雷回避）。<br/>
        代わりに「紹介を検索」「地図で見る」「公式サイト」が出ます。
      </div>
    </div>

    <div class="card detail" id="detail">
      <div style="color:var(--muted);font-size:12px;">「現在地周辺を検索」を押すと結果が出ます</div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:13px;margin-bottom:8px;">検索結果</div>
      <ul id="list"></ul>
    </div>
  </aside>

  <main id="map" aria-label="map"></main>
</div>

<script>
  // ----- Map (Leaflet + OSM tiles) -----
  const map = L.map('map', { zoomControl: true }).setView([35.681, 139.767], 13);

  // OSM public tiles: ok for prototypes; for heavy traffic, use a tile provider.
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let markers = [];
  let myLocationMarker = null;

  function clearMarkers(){
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  function setDetail(html){
    document.getElementById("detail").innerHTML = html;
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }

  // ----- Overpass Query -----
  function overpassQuery(lat, lon, radius, category){
    const types = (category === "all")
      ? ["school","kindergarten","language_school","music_school"]
      : [category];

    const filters = types.map(t => `
      nwr["amenity"="${t}"](around:${radius},${lat},${lon});
    `).join("");

    return `
      [out:json][timeout:25];
      (
        ${filters}
      );
      out center tags;
    `;
  }

  function formatAddress(tags){
    const parts = [
      tags?.["addr:full"],
      tags?.["addr:prefecture"],
      tags?.["addr:city"],
      tags?.["addr:suburb"],
      tags?.["addr:street"],
      tags?.["addr:housenumber"]
    ].filter(Boolean);
    return parts.join(" ");
  }

  function toItem(e){
    const tags = e.tags || {};
    const name = tags.name || tags["name:ja"] || "(名称なし)";
    const amenity = tags.amenity || "";
    const website = tags.website || tags.url || "";
    const addr = formatAddress(tags);

    const lat = e.lat ?? e.center?.lat;
    const lon = e.lon ?? e.center?.lon;

    return { id: e.id, type: e.type, name, amenity, website, addr, lat, lon, tags };
  }

  // ----- UI rendering -----
  function showItem(it){
    const q = it.name + (it.addr ? (" " + it.addr) : "");
    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(q)}`;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;

    const websiteHtml = it.website
      ? `<div style="margin-top:8px;"><a href="${it.website}" target="_blank" rel="noreferrer">公式サイト</a></div>`
      : `<div style="margin-top:8px;color:var(--muted);font-size:12px;">公式サイト情報なし</div>`;

    setDetail(`
      <div class="title" style="font-size:14px;">${escapeHtml(it.name)}</div>
      <div class="meta" style="margin-top:8px;">
        <span class="badge">${escapeHtml(it.amenity || "unknown")}</span>
        ${it.addr ? escapeHtml(it.addr) : "住所情報なし"}
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a href="${searchUrl}" target="_blank" rel="noreferrer">紹介を検索</a>
        <a href="${mapsUrl}" target="_blank" rel="noreferrer">地図で見る</a>
      </div>

      ${websiteHtml}

      <div style="margin-top:10px;font-size:11px;color:var(--muted);">
        ※ガワ版：外部サイト本文の自動取得・転載は行いません（リンクで案内）。
      </div>
    `);
  }

  function addMarker(it){
    const marker = L.marker([it.lat, it.lon]).addTo(map);
    marker.on('click', () => showItem(it));
    markers.push(marker);
  }

  function renderList(items){
    const list = document.getElementById("list");
    list.innerHTML = "";

    items.forEach((it, idx) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="title">${idx + 1}. ${escapeHtml(it.name)}</div>
        <div class="meta">
          <span class="badge">${escapeHtml(it.amenity || "unknown")}</span>
          ${it.addr ? escapeHtml(it.addr) : "住所情報なし"}
        </div>
      `;
      li.onclick = () => {
        map.setView([it.lat, it.lon], 16);
        showItem(it);
      };
      list.appendChild(li);
    });
  }

  // ----- Main search flow -----
  async function runSearch(){
    const btn = document.getElementById("btn");
    btn.disabled = true;
    btn.textContent = "検索中…";

    try{
      if(!navigator.geolocation){
        setDetail(`<div style="color:var(--danger);font-size:12px;">このブラウザは位置情報に対応していません。</div>`);
        return;
      }

      setDetail(`<div style="color:var(--muted);font-size:12px;">位置情報を取得中…</div>`);

      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: false,
          timeout: 10000
        });
      });

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Show my location
      if(myLocationMarker) map.removeLayer(myLocationMarker);
      myLocationMarker = L.circleMarker([lat, lon], {
        radius: 7, weight: 2, fillOpacity: 0.6
      }).addTo(map);

      map.setView([lat, lon], 14);

      const radius = document.getElementById("radius").value;
      const category = document.getElementById("category").value;

      const q = overpassQuery(lat, lon, radius, category);

      clearMarkers();
      document.getElementById("list").innerHTML = "";

      setDetail(`<div style="color:var(--muted);font-size:12px;">施設を取得中…</div>`);

      const url = "https://overpass-api.de/api/interpreter";
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: "data=" + encodeURIComponent(q)
      });

      if(!res.ok){
        throw new Error(`Overpass error: HTTP ${res.status}`);
      }

      const data = await res.json();
      const items = (data.elements || [])
        .map(toItem)
        .filter(x => typeof x.lat === "number" && typeof x.lon === "number");

      // Prefer named items
      items.sort((a,b) => (a.name === "(名称なし)") - (b.name === "(名称なし)"));

      // Render map + list
      items.forEach(addMarker);
      renderList(items);

      if(items.length === 0){
        setDetail(`<div style="color:var(--muted);font-size:12px;">0件ヒット。半径やカテゴリを変えて再検索してみてください。</div>`);
        return;
      }

      setDetail(`<div style="font-size:12px;color:var(--muted);">${items.length}件ヒット。リストかピンをクリック。</div>`);
      showItem(items[0]);

    }catch(err){
      console.error(err);
      setDetail(`<div style="color:var(--danger);font-size:12px;">
        取得に失敗しました（Overpassが混雑していることがあります）。時間を置いて再試行してください。
      </div>`);
    }finally{
      const btn = document.getElementById("btn");
      btn.disabled = false;
      btn.textContent = "現在地周辺を検索";
    }
  }

  document.getElementById("btn").addEventListener("click", runSearch);
</script>
</body>
</html>
