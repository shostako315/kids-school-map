<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kids School Finder - ã‚¨ãƒªã‚¢æ¤œç´¢ç‰ˆ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #4f46e5;
      --bg: #f8fafc;
      --panel: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

    header {
      height: 60px; padding: 0 20px; background: var(--panel); border-bottom: 2px solid var(--primary);
      display: flex; align-items: center; justify-content: space-between; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #app { display: flex; height: calc(100vh - 60px); }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    #left { width: 420px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--panel); }
    .scroll-area { overflow-y: auto; flex: 1; padding: 20px; }

    .search-card { background: #f1f5f9; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .form-group { margin-bottom: 12px; }
    label { font-size: 13px; font-weight: bold; color: var(--text); margin-bottom: 6px; display: block; }
    
    input, select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
      background: #fff; color: var(--text); font-size: 14px;
    }

    .btn-container { display: flex; gap: 8px; margin-top: 10px; }
    .btn-main {
      flex: 1; padding: 12px; border-radius: 8px; border: 0; font-weight: bold;
      background: var(--primary); color: white; cursor: pointer; transition: 0.2s;
    }
    .btn-sub {
      background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 10px; border-radius: 8px; cursor: pointer;
    }

    /* æ¤œç´¢çµæœãƒªã‚¹ãƒˆ */
    .list-item {
      border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 12px;
      cursor: pointer; position: relative; transition: 0.2s; background: #fff;
    }
    .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--primary); }
    .item-title { font-weight: bold; font-size: 15px; color: var(--primary); margin-bottom: 6px; }
    .tag-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; background: #eef2ff; color: var(--primary); border: 1px solid #c7d2fe; }

    /* ãƒãƒƒãƒ— */
    #right { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .map-overlay-btn {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: var(--panel); color: var(--text); border: 1px solid var(--primary);
      padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    @media (max-width: 900px) {
      #app { flex-direction: column; overflow: auto; }
      #left { width: 100%; height: auto; border-right: 0; }
      #map { height: 400px; }
    }
  </style>
</head>
<body>

<header>
  <strong><i class="fas fa-search-location"></i> ã“ã©ã‚‚ã‚¹ã‚¯ãƒ¼ãƒ«ãƒŠãƒ“ ğŸ—ºï¸</strong>
  <div style="font-size: 12px; color: var(--muted);">åœ°å›³ã‚’å‹•ã‹ã—ã¦ã€Œå†æ¤œç´¢ã€ã‚‚OK</div>
</header>

<div id="app">
  <aside id="left">
    <div class="scroll-area">
      <div class="search-card">
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> ã‚¨ãƒªã‚¢ãƒ»é§…åã§æ¢ã™</label>
          <div style="display:flex; gap:5px;">
            <input type="text" id="area-input" placeholder="ä¾‹ï¼šæ–°å®¿åŒºã€æ¨ªæµœé§…...">
            <button class="btn-sub" onclick="geocodeSearch()"><i class="fas fa-search"></i></button>
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-th-list"></i> ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="category">
            <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
            <option value="tutoring_centre" selected>å­¦ç¿’å¡¾ãƒ»ãã‚‚ã‚“</option>
            <option value="language_school">è‹±èªãƒ»è‹±ä¼šè©±</option>
            <option value="music_school">ãƒ”ã‚¢ãƒãƒ»éŸ³æ¥½æ•™å®¤</option>
            <option value="sports_centre">ä½“æ“ãƒ»ã‚¹ã‚¤ãƒŸãƒ³ã‚°</option>
            <option value="dance_school">ãƒ€ãƒ³ã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«</option>
            <option value="coding_school">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</option>
            <option value="kindergarten">ä¿è‚²åœ’ãƒ»å¹¼ç¨šåœ’</option>
          </select>
        </div>

        <div style="display: flex; gap: 10px;">
          <div style="flex:1">
            <label>åŠå¾„</label>
            <select id="radius">
              <option value="1000">1km</option>
              <option value="2000" selected>2km</option>
              <option value="5000">5km</option>
            </select>
          </div>
          <div style="flex:1">
            <label>å¯¾è±¡å¹´é½¢</label>
            <select id="age-filter">
              <option value="all">ã™ã¹ã¦</option>
              <option value="infant">å¹¼å… (0-6æ­³)</option>
              <option value="elementary">å°å­¦ç”Ÿ</option>
              <option value="junior">ä¸­å­¦ç”Ÿä»¥ä¸Š</option>
            </select>
          </div>
        </div>

        <div class="btn-container">
          <button id="search-btn" class="btn-main" onclick="searchCurrentLocation()">
            <i class="fas fa-crosshairs"></i> ç¾åœ¨åœ°ã§æ¤œç´¢
          </button>
        </div>
      </div>

      <div id="results-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin:0;">æ¤œç´¢çµæœ <span id="count" style="color:var(--primary)">0</span> ä»¶</h4>
      </div>
      <ul id="list" style="list-style:none; padding:0;"></ul>
    </div>
  </aside>

  <main id="right">
    <button id="move-search-btn" class="map-overlay-btn" style="display:none;" onclick="searchAtMapCenter()">
      <i class="fas fa-redo"></i> ã“ã®ã‚¨ãƒªã‚¢ã§å†æ¤œç´¢
    </button>
    <div id="map"></div>
  </main>
</div>

<script>
  // ã‚«ãƒ†ã‚´ãƒªè¨­å®šï¼ˆOSMã‚¿ã‚°ã¨ã®ç´ä»˜ã‘ï¼‰
  const CAT_CONFIG = {
    tutoring_centre: { color: '#4f46e5', icon: 'fa-pencil-alt', label: 'å¡¾' },
    language_school: { color: '#f59e0b', icon: 'fa-language', label: 'è‹±èª' },
    music_school: { color: '#ec4899', icon: 'fa-music', label: 'éŸ³æ¥½' },
    sports_centre: { color: '#10b981', icon: 'fa-running', label: 'ã‚¹ãƒãƒ¼ãƒ„' },
    kindergarten: { color: '#ef4444', icon: 'fa-child', label: 'åœ’' },
    all: { color: '#64748b', icon: 'fa-school', label: 'ã‚¹ã‚¯ãƒ¼ãƒ«' }
  };

  // ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆæ˜ã‚‹ã„ OSM æ¨™æº–ã‚¿ã‚¤ãƒ«ï¼‰
  const map = L.map('map').setView([35.681, 139.767], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let markers = L.layerGroup().addTo(map);
  let currentResults = [];

  // --- ä½æ‰€æ¤œç´¢ (Geocoding) ---
  async function geocodeSearch() {
    const query = document.getElementById('area-input').value;
    if(!query) return alert("å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      if(data.length > 0) {
        const target = data[0];
        map.setView([target.lat, target.lon], 15);
        searchAtMapCenter();
      } else {
        alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      }
    } catch(e) { alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
  }

  // --- æ–½è¨­æ¤œç´¢ (Overpass API) ---
  async function performSearch(lat, lon) {
    const radius = document.getElementById("radius").value;
    const cat = document.getElementById("category").value;
    const btn = document.getElementById("search-btn");
    
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ¤œç´¢ä¸­...`;
    document.getElementById("move-search-btn").style.display = "none";

    const amenityFilter = cat === "all" 
      ? `nwr["amenity"~"school|kindergarten|tutoring_centre|language_school|music_school"]`
      : `nwr["amenity"="${cat}"]`;
    
    const query = `[out:json][timeout:25];(${amenityFilter}(around:${radius},${lat},${lon}););out center;`;

    try {
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query)
      });
      const data = await res.json();
      currentResults = data.elements.map(e => ({
        ...e,
        lat: e.lat || e.center.lat,
        lon: e.lon || e.center.lon,
        dist: L.latLng(lat, lon).distanceTo(L.latLng(e.lat || e.center.lat, e.lon || e.center.lon))
      })).sort((a,b) => a.dist - b.dist);

      renderUI();
    } catch (e) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
      btn.disabled = false;
      btn.innerHTML = `<i class="fas fa-crosshairs"></i> ç¾åœ¨åœ°ã§æ¤œç´¢`;
    }
  }

  function renderUI() {
    const listEl = document.getElementById("list");
    listEl.innerHTML = "";
    markers.clearLayers();

    currentResults.forEach(item => {
      const tags = item.tags || {};
      const name = tags.name || tags["name:ja"] || "åç§°ä¸æ˜ã®æ–½è¨­";
      const amenity = tags.amenity || "school";
      const conf = CAT_CONFIG[amenity] || CAT_CONFIG.all;

      // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
      const m = L.marker([item.lat, item.lon]).addTo(markers);
      m.bindPopup(`<strong>${name}</strong><br>${tags["addr:full"] || ""}`);

      // ãƒªã‚¹ãƒˆä½œæˆ
      const li = document.createElement("li");
      li.className = "list-item";
      li.innerHTML = `
        <div class="item-title">${name}</div>
        <div style="font-size:12px; color:var(--muted);"><i class="fas fa-map-marker-alt"></i> å¾’æ­©ç´„${Math.round(item.dist/80)}åˆ† (${Math.round(item.dist)}m)</div>
        <div class="tag-row">
          <span class="tag"><i class="fas ${conf.icon}"></i> ${conf.label}</span>
          ${tags.website ? `<span class="tag" style="background:#fff7ed; color:#c2410c; border-color:#fed7aa;">HPã‚ã‚Š</span>` : ''}
        </div>
      `;
      li.onclick = () => {
        map.flyTo([item.lat, item.lon], 16);
        m.openPopup();
      };
      listEl.appendChild(li);
    });
    document.getElementById("count").textContent = currentResults.length;
  }

  // ãƒãƒ³ãƒ‰ãƒ©
  function searchCurrentLocation() {
    navigator.geolocation.getCurrentPosition(p => {
      const lat = p.coords.latitude;
      const lon = p.coords.longitude;
      map.setView([lat, lon], 15);
      L.circleMarker([lat, lon], { radius: 8, color: '#fff', fillOpacity: 1, fillColor: '#4f46e5' }).addTo(map);
      performSearch(lat, lon);
    });
  }

  function searchAtMapCenter() {
    const center = map.getCenter();
    performSearch(center.lat, center.lng);
  }

  map.on('moveend', () => {
    document.getElementById("move-search-btn").style.display = "block";
  });
</script>
</body>
</html>
