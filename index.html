<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kids School Finder Tokyo - Smart & Speed</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --brand: #ff6000; /* 食べログ風アクセント */
      --primary: #333;
      --bg: #f4f4f4;
      --panel: #ffffff;
      --border: #ddd;
    }
    * { box-sizing: border-box; font-family: "Hiragino Sans", "Meiryo", sans-serif; }
    body { margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* スマート検索バー */
    .smart-header {
      background: #fff; padding: 10px 20px; display: flex; align-items: center; gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2000;
    }
    .search-box {
      display: flex; flex: 1; max-width: 900px; border: 2px solid var(--brand); border-radius: 4px; overflow: hidden;
    }
    .search-input { border: none; padding: 12px; flex: 1; font-size: 15px; border-right: 1px solid var(--border); }
    .search-select { border: none; padding: 0 15px; background: #fff; font-weight: bold; cursor: pointer; border-right: 1px solid var(--border); }
    .search-btn { background: var(--brand); color: #fff; border: none; padding: 0 25px; cursor: pointer; font-weight: bold; }

    /* メインレイアウト */
    #content { display: flex; flex: 1; overflow: hidden; }

    /* サイドバー */
    #sidebar { width: 400px; background: #fff; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
    .sidebar-tabs { display: flex; background: #eee; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 13px; font-weight: bold; color: #666; }
    .tab.active { background: #fff; color: var(--brand); border-top: 2px solid var(--brand); }
    
    .list-container { flex: 1; overflow-y: auto; padding: 15px; }

    /* スクールカード */
    .s-card {
      border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; position: relative;
    }
    .s-name { font-weight: bold; font-size: 16px; color: #0066cc; margin-bottom: 4px; cursor: pointer; }
    .s-name:hover { text-decoration: underline; }
    .s-meta { font-size: 12px; color: #666; display: flex; gap: 10px; }
    .memo-area {
      margin-top: 10px; background: #fff9e6; border-radius: 4px; padding: 8px; border: 1px solid #ffeeba;
    }
    .memo-text {
      width: 100%; border: none; background: transparent; font-size: 12px; resize: none; outline: none;
    }

    /* マップ */
    #map-wrapper { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    #loading {
      position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
      background: var(--brand); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 2000; display: none;
    }

    @media (max-width: 800px) {
      #content { flex-direction: column; }
      #sidebar { width: 100%; height: 40vh; }
      .smart-header { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<header class="smart-header">
  <div style="font-weight: 800; font-size: 1.2rem; color: var(--brand); white-space: nowrap;">
    <i class="fas fa-search-location"></i> スクールナビ
  </div>
  <div class="search-box">
    <input type="text" id="loc-input" class="search-input" placeholder="駅名・エリア（例: 恵比寿）">
    <select id="cat-select" class="search-select">
      <option value="all">すべてのジャンル</option>
      <option value="tutoring_centre">学習塾・進学塾</option>
      <option value="language_school">英会話</option>
      <option value="music_school">ピアノ・音楽</option>
      <option value="coding_school">プログラミング</option>
      <option value="sports_centre">スポーツ・体操</option>
    </select>
    <button class="search-btn" onclick="executeSearch()">検索</button>
  </div>
</header>

<div id="content">
  <aside id="sidebar">
    <div class="sidebar-tabs">
      <div class="tab active" onclick="switchTab('results')" id="tab-res">検索結果</div>
      <div class="tab" onclick="switchTab('memos')" id="tab-memo">メモした履歴</div>
    </div>
    <div id="list" class="list-container">
      <div style="text-align:center; color:#999; margin-top:50px;">
        まずはエリアを入力して検索！
      </div>
    </div>
  </aside>

  <main id="map-wrapper">
    <div id="loading"><i class="fas fa-sync fa-spin"></i> 読込中...</div>
    <div id="map"></div>
  </main>
</div>

<script>
  // 東京エリアに限定したBBOX（高速化のため）
  const TOKYO_BBOX = "35.5,139.5,35.8,140.0";

  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 14);
  L.control.zoom({ position: 'bottomright' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const clusters = L.markerClusterGroup().addTo(map);
  let allResults = [];
  let currentTab = 'results';

  // メモデータの読み込み
  let memos = JSON.parse(localStorage.getItem('school_memos') || '{}');

  // --- 検索実行 ---
  async function executeSearch() {
    const loc = document.getElementById('loc-input').value;
    if (loc) {
      // ジオコーディング
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}&viewbox=139.5,35.8,140.0,35.5&bounded=1`);
      const data = await res.json();
      if (data[0]) {
        map.setView([data[0].lat, data[0].lon], 15);
      }
    }
    fetchData();
  }

  async function fetchData() {
    const loader = document.getElementById('loading');
    loader.style.display = 'block';
    
    const center = map.getCenter();
    const cat = document.getElementById('cat-select').value;
    const filter = cat === 'all' ? '["amenity"~"school|tutoring_centre|language_school|music_school"]' : `["amenity"="${cat}"]`;
    
    // 東京BBOX内かつ周辺2kmに限定した高速クエリ
    const query = `[out:json][timeout:15];(nwr${filter}(around:2000,${center.lat},${center.lng}););out center;`;

    try {
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query)
      });
      const data = await res.json();
      allResults = data.elements.map(e => ({
        id: e.id,
        name: e.tags.name || e.tags["name:ja"] || "名称未設定の施設",
        lat: e.lat || e.center.lat,
        lon: e.lon || e.center.lon,
        type: e.tags.amenity,
        addr: e.tags["addr:full"] || ""
      }));
      renderUI();
    } catch(e) {
      console.error(e);
    } finally {
      loader.style.display = 'none';
    }
  }

  // --- UI描画 ---
  function renderUI() {
    clusters.clearLayers();
    const listEl = document.getElementById('list');
    listEl.innerHTML = "";

    const displayData = currentTab === 'results' 
      ? allResults 
      : Object.values(memos); // メモがあるデータのみ表示

    if (displayData.length === 0) {
      listEl.innerHTML = `<div style="text-align:center;color:#999;margin-top:30px;">データがありません</div>`;
      return;
    }

    displayData.forEach(item => {
      // マーカー
      const marker = L.marker([item.lat, item.lon]);
      marker.bindPopup(`<b>${item.name}</b>`);
      clusters.addLayer(marker);

      // カード
      const card = document.createElement('div');
      card.className = "s-card";
      card.innerHTML = `
        <div class="s-name" onclick="focusMap(${item.lat}, ${item.lon})">${item.name}</div>
        <div class="s-meta">
          <span><i class="fas fa-tag"></i> ${item.type}</span>
          <span>${item.addr}</span>
        </div>
        <div class="memo-area">
          <textarea class="memo-text" placeholder="自分だけのメモを残す..." onchange="saveMemo(${item.id}, this.value, '${item.name.replace(/'/g, "")}', ${item.lat}, ${item.lon}, '${item.type}')">${memos[item.id]?.text || ""}</textarea>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  // --- メモ機能 ---
  function saveMemo(id, text, name, lat, lon, type) {
    if (text.trim() === "") {
      delete memos[id];
    } else {
      memos[id] = { id, text, name, lat, lon, type };
    }
    localStorage.setItem('school_memos', JSON.stringify(memos));
    if (currentTab === 'memos') renderUI();
  }

  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tab-res').classList.toggle('active', tab === 'results');
    document.getElementById('tab-memo').classList.toggle('active', tab === 'memos');
    renderUI();
  }

  function focusMap(lat, lon) {
    map.flyTo([lat, lon], 16);
  }

  // 地図移動後の自動検索（負荷調整のためディレイを入れる）
  let timer;
  map.on('moveend', () => {
    clearTimeout(timer);
    timer = setTimeout(fetchData, 1000);
  });

</script>
</body>
</html>
